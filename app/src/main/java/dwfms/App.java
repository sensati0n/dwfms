/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package dwfms;

import dwfms.collaboration.ethereum.EthereumCollaborationConnector;
import dwfms.collaboration.simple.SimpleConnector;
import dwfms.framework.*;
import dwfms.framework.collaboration.BaseCollaboration;
import dwfms.framework.collaboration.security.Utils;
import dwfms.framework.references.Instance;
import dwfms.framework.references.UserReference;
import dwfms.model.bpmn.BPMNModel;
import dwfms.model.BPMNToHybridExecutionMachineTransformer;
import dwfms.ui.HttpInterface;

import java.io.IOException;
import java.security.KeyPair;
import java.security.NoSuchAlgorithmException;
import java.util.List;
import java.util.concurrent.TimeUnit;

public class App {



    public static void main(String[] args) throws InterruptedException, NoSuchAlgorithmException, IOException {

        System.out.println("User: " + args[1]);
        System.out.println("Port: " + args[2]);

        DWFMS dWFMS = null;
        HttpInterface httpInterface;

        if(args[0].equals("simple")) {
            switch(args[1]) {
                case "hans":
                    dWFMS = setupSimpleDWFMS(ExampleDataFactory.hansSimple(), Integer.parseInt(args[2])+1);
                    break;
                case "peter":
                    dWFMS = setupSimpleDWFMS(ExampleDataFactory.peterSimple(), Integer.parseInt(args[2])+1);
                    break;
            }
        }
        else if(args[0].equals("eth")) {
            switch(args[1]) {
                case "hans":
                    dWFMS = setupEthereumDWFMS(ExampleDataFactory.hansEth());
                    break;
                case "peter":
                    dWFMS = setupEthereumDWFMS(ExampleDataFactory.peterEth());
                    break;
            }
        }

        httpInterface = new HttpInterface(dWFMS, Integer.parseInt(args[2]));

    }

    static DWFMS setupEthereumDWFMS(User user) throws InterruptedException {

        // start ganache-cli with deterministic wallet mnemonic:
        // ganache-cli -l 60000000 -b 15 -d -m "shiver armed industry victory sight vague follow spray couple hat obscure yard"

        IModel model = new BPMNModel();
        ITransformer transformer = new BPMNToHybridExecutionMachineTransformer();
        BaseCollaboration collaboration = new EthereumCollaborationConnector();

        DWFMS dWFMS = DWFMS.builder()
                .model(model)
                .transformer(transformer)
                .collaboration(collaboration)
                .build();

        dWFMS.init(user);

        Instance reference = dWFMS.deployProcessModel();
        System.out.println("Contract Address: " + reference.getInstanceRef());
        // InstanceReference reference = new InstanceReference("0xb709b82a554f07c7916109a0f55D0D6c995DBcc9");

        //dWFMS.executeTask(new TaskExecution(reference, "Start"));

        //dWFMS.executeTask(new TaskExecution(reference, "A"));
        //TimeUnit.SECONDS.sleep(2);
        //dWFMS.executeTask(new TaskExecution(reference, "C"));

        return dWFMS;
    }


    private static DWFMS setupSimpleDWFMS(User user, int port) {

        IModel model = new BPMNModel();
        ITransformer transformer = new BPMNToHybridExecutionMachineTransformer();
        BaseCollaboration collaboration = new SimpleConnector(port, List.of("http://localhost:3001/", "http://localhost:4001/"));

        DWFMS dWFMS = DWFMS.builder()
                .model(model)
                .transformer(transformer)
                .collaboration(collaboration)
                .build();

        dWFMS.init(user);

        return dWFMS;
    }



}
